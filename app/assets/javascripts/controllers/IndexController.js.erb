/**
 * Created by Геннадий on 28.08.2015.
 */
function IndexController($scope, gmap, Point, Comment) {
    var $this = this;
    this.heading = 'Алкомап (пре альфа)';
    this.currentPoint = undefined;

    var findPointInList = function(point)
    {
        var result = point;
        $this.points.forEach(function(item)
        {
            if(item.id == point.id)
                result=item;
        });
        return result;
    };
    this.addPoint = function () {
        var point = Point.new($scope.point, function (result) {
            $this.points.push(result);
            var marker = new google.maps.Marker({
                position: {lng: result.long, lat: result.lat},
                title: result.name,
                map: gmap
            });
            marker.addListener('click',function(event)
            {
                $this.currentPoint = findPointInList(result);
                console.log($this.currentPoint);
            });
            result.marker = marker;
        });
    };
    this.comment =function(){
        $scope.comment.point_id = $this.currentPoint.id;
        var comment = Comment.new($scope.comment, function(result)
        {
            $this.currentPoint.comments.push(result);
        });
        
    };
    var init = function () {

        Point.index(function (result) {
            $this.points = result;
            $this.points.forEach(function (item) {
                var marker = new google.maps.Marker({
                    position: {lng: item.long, lat: item.lat},
                    title: item.name,
                    map: gmap,
                    icon: '<%= asset_path 'bottle.png' %>'
                });
                marker.addListener('click',function(event)
                {
                    $this.currentPoint = findPointInList(item);
                    $scope.$apply();
                    console.log($this.currentPoint.comments);
                });
                item.marker = marker;
            });
            $this.currentPoint= $this.points[0];
            var marker = new google.maps.Marker({
                position: USER_POSITION,
                title: "Ето ты",
                icon: {
                    url: '<%= asset_path 'Alien.png' %>'
                },
                map: gmap
            });
        });
        $scope.point = {long: USER_POSITION.lng, lat: USER_POSITION.lat, name: 'Test', description: 'Description'};
    }();
}